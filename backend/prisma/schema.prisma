generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  shipper
  driver
  admin
  auditor
}

enum ShipmentStatus {
  created
  posted
  assigned
  en_route
  at_pickup
  picked_up
  in_transit
  at_dropoff
  delivered
  completed
  cancelled
  problem
}

enum TransactionType {
  payment
  refund
  penalty
  bonus
  withdrawal
  deposit
  platform_fee
}

enum TransactionStatus {
  pending
  completed
  failed
  cancelled
}

enum NotificationType {
  shipment_update
  payment_received
  penalty_applied
  new_message
  system_alert
  promotion
}

enum PenaltyType {
  late_pickup
  late_delivery
  no_show
  damaged_cargo
  unprofessional_behavior
  policy_violation
}

enum DocumentType {
  bill_of_lading
  proof_of_delivery
  insurance
  license
  registration
  contract
  invoice
  receipt
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String    @map("password_hash")
  role          UserRole
  isActive      Boolean   @default(true) @map("is_active")
  isVerified    Boolean   @default(false) @map("is_verified")
  phoneNumber   String?   @map("phone_number")
  profileImage  String?   @map("profile_image")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  shipper       Shipper?
  driver        Driver?
  wallet        Wallet?
  notifications Notification[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  @@map("users")
}

model Shipper {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  companyName    String   @map("company_name")
  contactPhone   String   @map("contact_phone")
  companyAddress String?  @map("company_address")
  taxId          String?  @map("tax_id")
  rating         Float    @default(0)
  totalShipments Int      @default(0) @map("total_shipments")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipments Shipment[]
  reviews   Review[]   @relation("ShipperReviews")
  documents Document[]

  @@map("shippers")
}

model Driver {
  id                  String    @id @default(uuid())
  userId              String    @unique @map("user_id")
  fullName            String    @map("full_name")
  phone               String
  licenseNumber       String?   @map("license_number")
  truckType           String?   @map("truck_type")
  truckModel          String?   @map("truck_model")
  truckPlate          String?   @map("truck_plate")
  truckCapacity       Float?    @map("truck_capacity")
  mcNumber            String?   @map("mc_number")
  dotNumber           String?   @map("dot_number")
  carrierStatus       String?   @map("carrier_status")
  insuranceCompany    String?   @map("insurance_company")
  insurancePolicy     String?   @map("insurance_policy")
  insuranceExpiration DateTime? @map("insurance_expiration")
  lastVerificationAt  DateTime? @map("last_verification_at")
  rating              Float     @default(0)
  totalDeliveries     Int       @default(0) @map("total_deliveries")
  isAvailable         Boolean   @default(true) @map("is_available")
  currentLat          Float?    @map("current_lat")
  currentLng          Float?    @map("current_lng")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipments            Shipment[]
  podEvents            PodEvent[]
  vehicleLocations     VehicleLocation[]
  carrierVerifications CarrierVerification[]
  reviews              Review[]              @relation("DriverReviews")
  penalties            Penalty[]
  documents            Document[]
  performanceMetrics   PerformanceMetric[]

  @@map("drivers")
}

model Shipment {
  id                   String         @id @default(uuid())
  shipperId            String         @map("shipper_id")
  driverId             String?        @map("driver_id")
  loadNumber           String?        @unique @map("load_number")
  pickupAddress        String         @map("pickup_address")
  dropoffAddress       String         @map("dropoff_address")
  pickupCity           String?        @map("pickup_city")
  pickupState          String?        @map("pickup_state")
  dropoffCity          String?        @map("dropoff_city")
  dropoffState         String?        @map("dropoff_state")
  pickupLat            Float          @map("pickup_lat")
  pickupLng            Float          @map("pickup_lng")
  dropoffLat           Float          @map("dropoff_lat")
  dropoffLng           Float          @map("dropoff_lng")
  status               ShipmentStatus @default(created)
  cargoType            String?        @map("cargo_type")
  cargoWeight          Float?         @map("cargo_weight")
  cargoDescription     String?        @map("cargo_description")
  specialInstructions  String?        @map("special_instructions")
  price                Float
  platformFee          Float          @default(0) @map("platform_fee")
  driverPayout         Float?         @map("driver_payout")
  distance             Float?
  estimatedDuration    Int?           @map("estimated_duration")
  estimatedPickupTime  DateTime?      @map("estimated_pickup_time")
  estimatedDeliveryTime DateTime?     @map("estimated_delivery_time")
  actualPickupTime     DateTime?      @map("actual_pickup_time")
  actualDeliveryTime   DateTime?      @map("actual_delivery_time")
  aiRouteData          Json?          @map("ai_route_data")
  aiScoreData          Json?          @map("ai_score_data")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  shipper           Shipper             @relation(fields: [shipperId], references: [id], onDelete: Cascade)
  driver            Driver?             @relation(fields: [driverId], references: [id], onDelete: SetNull)
  podEvents         PodEvent[]
  statusHistory     ShipmentStatusHistory[]
  documents         Document[]
  reviews           Review[]
  penalties         Penalty[]
  analytics         ShipmentAnalytics?

  @@map("shipments")
}

model ShipmentStatusHistory {
  id         String         @id @default(uuid())
  shipmentId String         @map("shipment_id")
  status     ShipmentStatus
  location   String?
  notes      String?
  lat        Float?
  lng        Float?
  createdAt  DateTime       @default(now()) @map("created_at")

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_status_history")
}

model PodEvent {
  id          String   @id @default(uuid())
  shipmentId  String   @map("shipment_id")
  driverId    String   @map("driver_id")
  imageUrl    String   @map("image_url")
  gpsLat      Float    @map("gps_lat")
  gpsLng      Float    @map("gps_lng")
  deviceTime  DateTime @map("device_time")
  serverTime  DateTime @default(now()) @map("server_time")
  fraudScore  Int      @map("fraud_score")
  fraudReason String?  @map("fraud_reason")
  ocrText     String?  @map("ocr_text")
  aiAnalysis  Json?    @map("ai_analysis")
  isApproved  Boolean  @map("is_approved")
  createdAt   DateTime @default(now()) @map("created_at")

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  driver   Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("pod_events")
}

model VehicleLocation {
  id         String   @id @default(uuid())
  driverId   String   @map("driver_id")
  gpsLat     Float    @map("gps_lat")
  gpsLng     Float    @map("gps_lng")
  heading    Float?
  speed      Float?
  accuracy   Float?
  capturedAt DateTime @default(now()) @map("captured_at")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, capturedAt])
  @@map("vehicle_locations")
}

model CarrierVerification {
  id                      String    @id @default(uuid())
  driverId                String    @map("driver_id")
  mcNumber                String?   @map("mc_number")
  dotNumber               String?   @map("dot_number")
  authorityStatus         String?   @map("authority_status")
  insuranceBipdLimit      Float?    @map("insurance_bipd_limit")
  insuranceCargoLimit     Float?    @map("insurance_cargo_limit")
  insuranceEffectiveDate  DateTime? @map("insurance_effective_date")
  insuranceExpirationDate DateTime? @map("insurance_expiration_date")
  sourceRawJson           Json?     @map("source_raw_json")
  createdAt               DateTime  @default(now()) @map("created_at")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("carrier_verifications")
}

model Wallet {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  balance        Float    @default(0)
  pendingBalance Float    @default(0) @map("pending_balance")
  totalEarnings  Float    @default(0) @map("total_earnings")
  totalSpent     Float    @default(0) @map("total_spent")
  stripeAccountId String? @map("stripe_account_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String            @map("wallet_id")
  type            TransactionType
  status          TransactionStatus @default(pending)
  amount          Float
  description     String?
  referenceId     String?           @map("reference_id")
  stripePaymentId String?           @map("stripe_payment_id")
  metadata        Json?
  createdAt       DateTime          @default(now()) @map("created_at")
  completedAt     DateTime?         @map("completed_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Review {
  id         String   @id @default(uuid())
  shipmentId String   @map("shipment_id")
  driverId   String?  @map("driver_id")
  shipperId  String?  @map("shipper_id")
  reviewerId String   @map("reviewer_id")
  rating     Int
  comment    String?
  isPublic   Boolean  @default(true) @map("is_public")
  createdAt  DateTime @default(now()) @map("created_at")

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  driver   Driver?  @relation("DriverReviews", fields: [driverId], references: [id], onDelete: Cascade)
  shipper  Shipper? @relation("ShipperReviews", fields: [shipperId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Penalty {
  id          String      @id @default(uuid())
  shipmentId  String?     @map("shipment_id")
  driverId    String      @map("driver_id")
  type        PenaltyType
  amount      Float
  reason      String
  description String?
  isActive    Boolean     @default(true) @map("is_active")
  isPaid      Boolean     @default(false) @map("is_paid")
  createdAt   DateTime    @default(now()) @map("created_at")
  paidAt      DateTime?   @map("paid_at")

  shipment Shipment? @relation(fields: [shipmentId], references: [id], onDelete: SetNull)
  driver   Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("penalties")
}

model Document {
  id          String       @id @default(uuid())
  shipmentId  String?      @map("shipment_id")
  driverId    String?      @map("driver_id")
  shipperId   String?      @map("shipper_id")
  type        DocumentType
  fileName    String       @map("file_name")
  fileUrl     String       @map("file_url")
  fileSize    Int?         @map("file_size")
  mimeType    String?      @map("mime_type")
  description String?
  isVerified  Boolean      @default(false) @map("is_verified")
  aiExtracted Json?        @map("ai_extracted")
  createdAt   DateTime     @default(now()) @map("created_at")
  expiresAt   DateTime?    @map("expires_at")

  shipment Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  driver   Driver?   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  shipper  Shipper?  @relation(fields: [shipperId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")
  readAt    DateTime?        @map("read_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  subject    String?
  message    String
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")
  readAt     DateTime? @map("read_at")

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId])
  @@map("messages")
}

model PerformanceMetric {
  id                  String   @id @default(uuid())
  driverId            String   @map("driver_id")
  date                DateTime @default(now())
  totalDeliveries     Int      @default(0) @map("total_deliveries")
  onTimeDeliveries    Int      @default(0) @map("on_time_deliveries")
  lateDeliveries      Int      @default(0) @map("late_deliveries")
  averageRating       Float    @default(0) @map("average_rating")
  totalEarnings       Float    @default(0) @map("total_earnings")
  totalMiles          Float    @default(0) @map("total_miles")
  totalPenalties      Float    @default(0) @map("total_penalties")
  efficiencyScore     Float    @default(0) @map("efficiency_score")
  customerSatisfaction Float   @default(0) @map("customer_satisfaction")

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, date])
  @@map("performance_metrics")
}

model ShipmentAnalytics {
  id                    String   @id @default(uuid())
  shipmentId            String   @unique @map("shipment_id")
  actualDistance        Float?   @map("actual_distance")
  fuelEfficiency        Float?   @map("fuel_efficiency")
  routeDeviation        Float?   @map("route_deviation")
  stopsCount            Int?     @map("stops_count")
  idleTimeMinutes       Int?     @map("idle_time_minutes")
  averageSpeed          Float?   @map("average_speed")
  weatherImpact         Json?    @map("weather_impact")
  trafficImpact         Json?    @map("traffic_impact")
  aiRecommendations     Json?    @map("ai_recommendations")
  profitabilityScore    Float?   @map("profitability_score")
  createdAt             DateTime @default(now()) @map("created_at")

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_analytics")
}

model SystemConfiguration {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configuration")
}
